<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/images/logo.png" />
    <title>Search History</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/history.css" />
    <script defer src="/js/history.js"></script>
  </head>
  <body class="layout-body">
    <%- include("partials/header") %> 
    <% if (toast) { %>
    <script>
      var toast = <%- JSON.stringify(toast) %>;
    </script>
    <% } %>

    <main class="layout-main">
      <section class="history-section">
        <h2 class="center-title">Search History</h2>

        <!-- ðŸ” Filter input -->
        <div class="filter-bar">
          <input
            type="text"
            id="historySearchInput"
            placeholder="Search by video name or query..."
          />
        </div>

        <% if (Object.keys(videoMap).length === 0) { %>
        <p>No videos uploaded yet.</p>
        <% } else { %> 
          <% for (let videoId in videoMap) { let { video, queries } = videoMap[videoId]; %>

        <div class="history-table-wrapper">
          <div class="video-container">
            <video controls>
              <source src="/uploads/<%= video.filename %>" type="video/mp4" />
            </video>
            <div class="caption"><%= video.title || video.filename %></div>
            <div class="actions">
              <a class="btn-download" href="/videos/download/<%= video._id %>">Download Video</a>
              <button
                class="btn-remove trigger-delete"
                data-delete-url="/videos/delete/<%= video._id %>"
              >
                Delete Video
              </button>
              <a class="btn-download" href="/api/search/search-again/<%= video._id %>">Search Again</a>
            </div>
          </div>

          <% if (Object.keys(queries).length === 0) { %>
          <p style="text-align: center; margin-top: 1rem">No queries for this video.</p>
          <% } else { %> 
            <% for (let queryId in queries) { let { query, results } = queries[queryId]; %>
          <div class="history-table">
            <table>
              <thead>
                <tr>
                  <th colspan="3">Query: <%= query.query %></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3">
                    <form action="/queries/delete/<%= query._id %>" method="POST">
                      <button class="btn-remove" onclick="return confirm('Delete this query and all its results?')">
                        Delete Query
                      </button>
                    </form>
                  </td>
                </tr>

                <% if (results.length === 0) { %>
                <tr>
                  <td colspan="3">No results found.</td>
                </tr>
                <% } else { %> 
                  <% results.forEach(result => { %>
                <tr>
                  <td>
                    <video width="240" controls>
                      <source src="/output/clips/<%= result.clipFilename %>" type="video/mp4" />
                    </video>
                  </td>
                  <td class="caption">Time: <%= result.timeRange %></td>
                  <td class="actions">
                    <a class="btn-download" href="/results/download/<%= result._id %>">Download</a>
                    <form action="/results/delete/<%= result._id %>" method="POST">
                      <button class="btn-remove" onclick="return confirm('Delete this result?')">Delete</button>
                    </form>
                  </td>
                </tr>
                <% }); %> 
                <% } %>
              </tbody>
            </table>
          </div>
          <% } %> 
          <% } %>
        </div>
        <% } %> 
        <% } %>
      </section>

      <div class="pagination">
        <% if (totalPages > 1) { %> 
          <% for (let i = 1; i <= totalPages; i++) { %>
        <a href="/history?page=<%= i %>" class="page-btn <%= currentPage === i ? 'active' : '' %>"><%= i %></a>
        <% } %> 
        <% } %>
      </div>
    </main>

    <!-- Custom delete confirmation modal -->
    <div id="deleteModal" class="modal hidden">
      <div class="modal-content">
        <h3>Delete This Video?</h3>
        <p>This will permanently delete the video and all related queries and results.</p>
        <div class="modal-buttons">
          <button id="cancelDelete" class="btn-cancel">Cancel</button>
          <a id="confirmDelete" class="btn-delete">Yes, Delete</a>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const deleteButtons = document.querySelectorAll(".trigger-delete");
        const modal = document.getElementById("deleteModal");
        const confirmBtn = document.getElementById("confirmDelete");
        const cancelBtn = document.getElementById("cancelDelete");

        deleteButtons.forEach(btn => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const deleteUrl = btn.getAttribute("data-delete-url");
            confirmBtn.setAttribute("href", deleteUrl);
            modal.classList.remove("hidden");
          });
        });

        cancelBtn.addEventListener("click", () => {
          modal.classList.add("hidden");
        });
      });
    </script>

    <%- include("partials/footer") %>
  </body>
</html>